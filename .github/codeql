name: "CodeQL"

on:
  push:
    branches: [ "master" ]
  
#  schedule:
 #   - cron: '0 2 * * 1-5'
    
jobs:
  analyze:
    name: Analyze
    runs-on: ${{ (matrix.language == 'swift' && fromJSON('[ "self-hosted", "macOS" ]')) || 'self-hosted' }}
    permissions:
      id-token: write
      actions: write
      contents: write
      security-events: write
      packages: write
      deployments: write
    
    strategy:
      fail-fast: false
      matrix:
        language: [ 'csharp']

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3.0.0

    - name: Setup Node npm
      uses: actions/setup-node@v3    
   
    - name: Setup .NET SDK
      uses: actions/setup-dotnet@v3
          
    - name: Setup NuGet CLI
      uses: nuget/setup-nuget@v1
      with:
       nuget-version: 'latest'
    
    - name: Install Dependencies
      run: npm install
      
    - name: Initialize CodeQL
      uses: github/codeql-action/init@v3
      with:
         queries: security-and-quality
         languages: csharp    
         
    - uses: jfrog/setup-jfrog-cli@v3
       
      with:
          oidc-provider-name: "ghes-prod"
          oidc-audience: "jfrog-github"
      env: 
        
         JF_URL: ${{ secrets.JF_URL }}
         
    - uses: jfrog/setup-jfrog-cli@v3
      env:

         JF_URL: ${{ secrets.JF_URL }}
          # [Mandatory if JF_USER and JF_PASSWORD are not provided]
          # JFrog access token with 'read' permissions on Xray service
         JF_ACCESS_TOKEN: ${{ secrets.JF_ACCESS_TOKEN  }}

          # [Mandatory]
          # The GitHub token is automatically generated for the job
         JF_GIT_TOKEN: ${{ secrets.GIT_TOKEN }}
       
          
    - name: Restore and Build
      run: |
       nuget restore SAMS_NET_CLIENT\src\Solutions\Ikea.Sams.App.Sams.sln
       msbuild SAMS_NET_CLIENT\src\Solutions\Ikea.Sams.App.Sams.sln /p:Configuration=Release /t:Rebuild
      shell: cmd
        

    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v2
      with:
        category: "/language:${{matrix.language}}"
